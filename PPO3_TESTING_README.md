# PPO3 Model Testing Guide

This guide explains how to test the `ppo_metadrive_best_model.pth` model generated by `ppo_metadrive3.py`.

## Files Created

1. **`test_ppo_metadrive3_best_model.py`** - Comprehensive test script for the PPO3 model
2. **`simple_test_ppo3.py`** - Simple model loading verification script

## Quick Start

### 1. Verify Model Loading
First, make sure the model can be loaded correctly:
```bash
python3 simple_test_ppo3.py
```

### 2. Basic Testing
Test the model with a few episodes:
```bash
python3 test_ppo_metadrive3_best_model.py --episodes 3
```

### 3. Fast Testing (No Rendering)
For faster testing without visualization:
```bash
python3 test_ppo_metadrive3_best_model.py --episodes 5 --no-render
```

## Advanced Usage

### Interactive Mode
Run in interactive mode for flexible testing:
```bash
python3 test_ppo_metadrive3_best_model.py --interactive
```

Available commands in interactive mode:
- `test` - Test single episode
- `multi` - Test multiple episodes
- `video` - Test with video recording
- `analyze` - Detailed analysis of single episode
- `quit` - Exit

### Video Recording
Record a video of the agent driving:
```bash
python3 test_ppo_metadrive3_best_model.py --video --episodes 1
```

### Quiet Mode
Reduce output verbosity:
```bash
python3 test_ppo_metadrive3_best_model.py --episodes 10 --quiet
```

## Model Architecture

The PPO3 model includes:
- **Actor Network**: 3,362,180 parameters with FiLM layers
- **Critic Network**: 1,508,129 parameters
- **VAE Guide**: 51,562 parameters for latent representation
- **Z-Value Network**: For latent value estimation

## Performance Metrics

The test script provides comprehensive metrics:
- **Episode Rewards**: Total reward per episode
- **Success Rate**: Percentage of episodes completed without timeout
- **Critic Values**: State value estimates
- **VAE Reconstruction Loss**: Latent representation quality
- **Action Statistics**: Throttle and steering action distributions

## Output Files

The test script can generate:
- `ppo3_test_performance.png` - Comprehensive performance plots
- `ppo3_test_video.mp4` - Video recording of agent behavior
- Individual frame images (if OpenCV not available)

## Troubleshooting

### Common Issues

1. **Model not found**: Ensure `ppo_metadrive_best_model.pth` exists in the current directory
2. **CUDA errors**: The script automatically falls back to CPU if CUDA is not available
3. **Import errors**: Make sure all dependencies are installed (see requirements.txt)

### Performance Expectations

Based on the model architecture and training:
- **Excellent**: >100 average reward
- **Good**: 50-100 average reward  
- **Fair**: 20-50 average reward
- **Poor**: <20 average reward

## Example Output

```
🚗 Initializing PPO3 Model Tester...
PPO3 model loaded successfully!
  - Actor: 3362180 parameters
  - Critic: 1508129 parameters
  - VAE: 51562 parameters
Model loaded successfully from ppo_metadrive_best_model.pth
Using device: cuda
Model architecture: PPO3 with VAE and FiLM layers

Testing PPO3 model on 5 episodes...

--- Episode 1/5 ---
Starting episode 1...
  Step 50, Reward: 12.34, Critic Value: 0.123
  Step 100, Reward: 25.67, Critic Value: 0.234
Episode 1 completed!
  Total reward: 45.67
  Steps: 150
  Success: True
  Avg Critic Value: 0.178
  Avg VAE Loss: 0.0123
  Action Std (throttle/steering): 0.234/0.456

============================================================
PPO3 MODEL TEST RESULTS SUMMARY
============================================================
Number of episodes: 5
Average reward: 42.34 ± 8.76
Best reward: 56.78
Worst reward: 28.90
Success rate: 80.00%

Detailed Metrics:
  Average Critic Value: 0.156 ± 0.023
  Average VAE Loss: 0.0112 ± 0.0023
  Throttle Action Std: 0.234 ± 0.045
  Steering Action Std: 0.456 ± 0.078

👍 GOOD performance! Model shows solid driving skills.
```

## Requirements

- Python 3.7+
- PyTorch
- MetaDrive
- Gymnasium
- Matplotlib
- NumPy
- OpenCV (optional, for video recording)

## Notes

- The script automatically handles the complex PPO3 architecture with VAE and FiLM layers
- All models are set to evaluation mode during testing
- The script provides detailed analysis of the agent's behavior and performance
- Video recording requires OpenCV; if not available, frames are saved as individual images
